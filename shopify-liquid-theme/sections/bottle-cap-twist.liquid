<style>
  .cap-twist {
    position: relative;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(180deg, #2d1810 0%, #1a1410 100%);
    overflow: hidden;
  }

  .cap-twist__container {
    position: relative;
    width: 100%;
    max-width: 800px;
    padding: 0 40px;
  }

  .cap-twist__text {
    text-align: center;
    margin-bottom: 80px;
    opacity: 0;
    transform: translateY(30px);
    transition: all 1s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .cap-twist__text.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .cap-twist__headline {
    font-size: clamp(36px, 5vw, 72px);
    font-weight: 700;
    color: #fff;
    margin: 0 0 16px 0;
    letter-spacing: -0.02em;
  }

  .cap-twist__subhead {
    font-size: clamp(18px, 2.5vw, 24px);
    color: rgba(255, 255, 255, 0.6);
    font-weight: 300;
  }

  .cap-twist__visual {
    position: relative;
    height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cap-twist__cap {
    width: 200px;
    height: 80px;
    position: relative;
    transform: rotate(0deg) translateY(0);
    transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .cap-twist__cap.twisting {
    transform: rotate(-45deg) translateY(-60px);
  }

  .cap-twist__cap.removed {
    transform: rotate(-180deg) translateY(-200px);
    opacity: 0;
  }

  .steam-particle {
    position: absolute;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 200, 150, 0.4) 0%, transparent 70%);
    opacity: 0;
    animation: steam 3s ease-out forwards;
  }

  @keyframes steam {
    0% {
      opacity: 0;
      transform: translateY(0) scale(0.5);
    }
    20% {
      opacity: 1;
    }
    100% {
      opacity: 0;
      transform: translateY(-150px) scale(1.5);
    }
  }

  .cap-twist__bottle-neck {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 200px;
    opacity: 0;
    transition: opacity 0.8s ease;
  }

  .cap-twist__bottle-neck.visible {
    opacity: 1;
  }

  .ripple {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 300px;
    height: 300px;
    border: 2px solid rgba(255, 100, 50, 0.6);
    border-radius: 50%;
    transform: translate(-50%, -50%) scale(0);
    animation: ripple 2s ease-out forwards;
  }

  @keyframes ripple {
    to {
      transform: translate(-50%, -50%) scale(2);
      opacity: 0;
    }
  }
</style>

<div class="cap-twist" data-section-id="{{ section.id }}">
  <div class="cap-twist__container">
    <div class="cap-twist__text">
      <h2 class="cap-twist__headline">{{ section.settings.headline }}</h2>
      <p class="cap-twist__subhead">{{ section.settings.subhead }}</p>
    </div>

    <div class="cap-twist__visual">
      <div class="cap-twist__bottle-neck">
        <svg viewBox="0 0 120 200" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M 30 0 L 25 40 L 20 80 L 20 200 L 100 200 L 100 80 L 95 40 L 90 0 Z" 
                fill="url(#neckGradient)" opacity="0.9"/>
          <ellipse cx="60" cy="5" rx="30" ry="8" fill="rgba(255,255,255,0.1)"/>
          <defs>
            <linearGradient id="neckGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.15" />
              <stop offset="50%" style="stop-color:#ffffff;stop-opacity:0.05" />
              <stop offset="100%" style="stop-color:#000000;stop-opacity:0.1" />
            </linearGradient>
          </defs>
        </svg>
      </div>

      <div class="cap-twist__cap">
        <svg viewBox="0 0 200 80" fill="none" xmlns="http://www.w3.org/2000/svg">
          <ellipse cx="100" cy="70" rx="60" ry="10" fill="rgba(0,0,0,0.3)" opacity="0.5"/>
          <rect x="40" y="20" width="120" height="50" rx="8" fill="#2a2a2a"/>
          <rect x="45" y="25" width="110" height="40" rx="6" fill="#3a3a3a"/>
          <circle cx="100" cy="45" r="25" fill="#1a1a1a"/>
          <circle cx="100" cy="45" r="20" fill="#2a2a2a"/>
          <path d="M 90 45 L 110 45 M 100 35 L 100 55" stroke="#555" stroke-width="3" stroke-linecap="round"/>
          
          <!-- Ridges -->
          {% for i in (0..11) %}
            <line x1="{{ 50 | plus: i | times: 10 }}" y1="28" x2="{{ 50 | plus: i | times: 10 }}" y2="62" 
                  stroke="#555" stroke-width="2" opacity="0.6"/>
          {% endfor %}
        </svg>
      </div>

      <div class="cap-twist__steam-container"></div>
    </div>
  </div>
</div>

<script>
  (function() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    const text = section.querySelector('.cap-twist__text');
    const cap = section.querySelector('.cap-twist__cap');
    const bottleNeck = section.querySelector('.cap-twist__bottle-neck');
    const steamContainer = section.querySelector('.cap-twist__steam-container');
    const visual = section.querySelector('.cap-twist__visual');
    
    let animated = false;
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !animated) {
          animated = true;
          
          // Show text
          setTimeout(() => text.classList.add('visible'), 200);
          
          // Show bottle neck
          setTimeout(() => bottleNeck.classList.add('visible'), 600);
          
          // Start twisting
          setTimeout(() => {
            cap.classList.add('twisting');
            
            // Add ripple effect
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            visual.appendChild(ripple);
          }, 1000);
          
          // Remove cap and release steam
          setTimeout(() => {
            cap.classList.remove('twisting');
            cap.classList.add('removed');
            
            // Generate steam particles
            for (let i = 0; i < 8; i++) {
              setTimeout(() => {
                const steam = document.createElement('div');
                steam.className = 'steam-particle';
                steam.style.left = `${45 + Math.random() * 10}%`;
                steam.style.top = '40%';
                steam.style.animationDelay = `${i * 0.15}s`;
                steamContainer.appendChild(steam);
                
                setTimeout(() => steam.remove(), 3000);
              }, i * 200);
            }
          }, 2200);
        }
      });
    }, { threshold: 0.4 });
    
    observer.observe(section);
  })();
</script>

{% schema %}
{
  "name": "Bottle Cap Twist",
  "settings": [
    {
      "type": "text",
      "id": "headline",
      "label": "Headline",
      "default": "The First Twist"
    },
    {
      "type": "text",
      "id": "subhead",
      "label": "Subhead",
      "default": "Where flavor meets anticipation"
    }
  ],
  "presets": [
    {
      "name": "Bottle Cap Twist"
    }
  ]
}
{% endschema %}
